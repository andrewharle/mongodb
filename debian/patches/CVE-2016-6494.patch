Description: prevent group and other access on .dbshell
 Use umask on file creation and chmod on existing file load.
Forwarded: no
Bug-Debian: https://bugs.debian.org/832908
Author: Laszlo Boszormenyi (GCS) <gcs@debian.org>
Last-Update: 2016-08-04

---

--- a/src/mongo/shell/linenoise.cpp
+++ b/src/mongo/shell/linenoise.cpp
@@ -105,6 +105,7 @@
 #include <stdlib.h>
 #include <string.h>
 #include <sys/types.h>
+#include <sys/stat.h>
 #include <sys/ioctl.h>
 #include <cctype>
 #include <wctype.h>
@@ -2765,7 +2766,10 @@
 /* Save the history in the specified file. On success 0 is returned
  * otherwise -1 is returned. */
 int linenoiseHistorySave(const char* filename) {
+    mode_t old_umask;
+    old_umask = umask(S_IRWXG | S_IRWXO);
     FILE* fp = fopen(filename, "wt");
+    umask(old_umask);
     if (fp == NULL) {
         return -1;
     }
@@ -2790,6 +2794,8 @@
         return -1;
     }
 
+    chmod(filename, 00600);
+
     char buf[LINENOISE_MAX_LINE];
     while (fgets(buf, LINENOISE_MAX_LINE, fp) != NULL) {
         char* p = strchr(buf, '\r');
