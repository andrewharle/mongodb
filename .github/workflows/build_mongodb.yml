name: Build monogdb for debian buster

on:
  workflow_dispatch:
      inputs:
        branch_select:
          description: 'Branch to build from'
          required: true
          default: 'debian/buster' 
          type: choice
          options:
          - debian/buster
          - debian/stretch
          - master
          - debian/buster_arm64
        arch_select:
          description: 'Architecture to Build for'
          required: true
          default: 'armhf' 
          type: choice
          options:
          - armhf
          - arm64
          - amd64
          - i686

jobs:

  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Install the pre-requisites
        run:  sudo apt-get update && sudo apt-get install sbuild-debian-developer-setup git-buildpackage debhelper
      
      - name: Create sbuild environment
        run: |
              sudo sbuild-debian-developer-setup --distribution=debian --suite=buster && \
              sudo sbuild-adduser runner && newgrp sbuild
      
      - name: Free disk space
        run: |
          df --human-readable
          sudo apt clean
          docker rmi $(docker image ls --all --quiet)
          rm -rf "$AGENT_TOOLSDIRECTORY"
          df --human-readable
          
      - name: Set Swap
        shell: bash
        run: |
            echo "Memory and swap (before):"
            free -h
            echo
            swapon --show
            echo
            export SWAP_FILE=$(swapon --show=NAME | tail -n 1)
            sudo swapoff $SWAP_FILE
            sudo rm $SWAP_FILE
            sudo fallocate -l 4096M $SWAP_FILE
            sudo chmod 600 $SWAP_FILE
            sudo mkswap $SWAP_FILE
            sudo swapon $SWAP_FILE
            
      - name: Swap space report after modification
        shell: bash
        run: |
          echo "Memory and swap (after):"
          free -h
          echo
          swapon --show
          echo
        
      - name: Checkout & Build
        run: |
            gbp clone --debian-branch=${{ github.event.inputs.branch_select }} https://github.com/andrewharle/mongodb.git && \
            cd mongodb && \
            sudo gbp buildpackage --git-debian-branch=${{ github.event.inputs.branch_select }} --git-upstream-tag='v%(version)s' \
            --git-builder=DEB_BUILD_OPTIONS=parallel=$(nproc) sbuild --chroot=buster-amd64-sbuild \
            --host=${{ github.event.inputs.arch_select }} --profiles=cross && \
            cd ..
      
      - name: Rename Files in Compliance with Artifacts
        if: ${{ always() }}
        run: find . -maxdepth 1 -type f -exec sh -c "echo \$(basename {}) | sed -e 's/[ \t:\/\\\"<>|*?]/-/g' -e 's/--*/-/g'| xargs mv {}" \;
      
      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v3
        with:
          name: Deb packages
          path: |
            ./*.deb
            ./*.build
            ./*.tar.xz
            ./*.dsc 
            ./*.build 
            ./*.buildinfo
            ./*.changes
            !./*dbgsym*.deb
